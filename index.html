<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Society Finance Manager Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .hidden { display: none; }
        #toast { transform: translateY(150%); transition: transform 0.3s ease-in-out; }
        #toast.show { transform: translateY(0); }
        .tab-active { border-color: #3b82f6; color: #3b82f6; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="app" class="p-4 sm:p-6 lg:p-8 max-w-7xl mx-auto">
        <div id="loading" class="text-center py-10"><p class="text-slate-500">Loading Application...</p></div>

        <div id="auth-container" class="hidden max-w-md mx-auto bg-white rounded-2xl shadow-lg p-8 mt-10">
             <h2 class="text-2xl font-bold text-center">Society Login</h2>
             <form id="loginForm" class="mt-6">
                 <div class="mb-4"><label for="loginEmail" class="block text-sm font-medium">Email</label><input type="email" id="loginEmail" required class="mt-1 w-full border-slate-300 rounded-md p-2"></div>
                 <div class="mb-6"><label for="loginPassword" class="block text-sm font-medium">Password</label><input type="password" id="loginPassword" required class="mt-1 w-full border-slate-300 rounded-md p-2"></div>
                 <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-md">Login</button>
             </form>
             <p id="authError" class="text-red-500 text-sm mt-4 text-center"></p>
        </div>

        <div id="content-container" class="hidden">
            <header class="mb-8 flex flex-col sm:flex-row justify-between sm:items-center gap-4">
                <div>
                    <h1 id="header-title" class="text-3xl md:text-4xl font-bold text-slate-900">Finance Dashboard</h1>
                    <p class="text-slate-500 mt-2" id="welcomeMessage"></p>
                </div>
                <button id="logoutButton" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-md shadow-md w-full sm:w-auto">Logout</button>
            </header>

            <div id="dashboard-view">
                <div class="mb-8">
                    <div id="total-balance-card" class="bg-teal-600 text-white p-6 rounded-lg shadow-lg">
                        <h3 class="font-medium text-teal-100">Total Society Balance (from Summaries)</h3>
                        <p id="total-society-balance" class="text-4xl font-bold mt-2">₹0.00</p>
                    </div>
                </div>

                <h2 class="text-2xl font-semibold text-slate-800 mb-4">Detailed Finance Sheets</h2>
                <div class="flex flex-col sm:flex-row justify-end gap-3 mb-4">
                    <button id="manage-residents-btn" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md">Manage Residents</button>
                    <button id="open-sheet-recycle-bin-modal" class="bg-slate-500 text-white font-semibold py-2 px-4 rounded-md">Sheet Recycle Bin</button>
                    <button id="open-create-sheet-modal" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-md">+ Create New Sheet</button>
                </div>
                <div id="sheets-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                <p id="no-sheets-message" class="text-center text-slate-500 py-16 hidden">No finance sheets yet.</p>

                <div class="mt-12">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold text-slate-800">High-Level Monthly Summary</h2>
                        <button id="open-add-month-modal" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-md shadow-md hover:bg-green-700">+ Add Month Summary</button>
                    </div>
                    <div id="monthly-summary-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"></div>
                    <p id="no-summary-message" class="text-center text-slate-500 py-16 hidden">No monthly summaries added yet.</p>
                </div>
            </div>
            
            <div id="residents-view" class="hidden">
                 <div class="mb-6"><button id="back-to-dashboard-from-residents" class="text-blue-600 font-semibold flex items-center">&larr; Back to Dashboard</button></div>
                 <div class="bg-white p-6 rounded-lg shadow-md">
                     <h2 class="text-2xl font-semibold mb-4">Manage Residents</h2>
                     <form id="resident-form" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-6 gap-4 items-end mb-6">
                         <div class="md:col-span-1"><label for="r-flat" class="text-sm">Flat No.</label><input type="text" id="r-flat" placeholder="A-101" required class="mt-1 w-full p-2 border-slate-300 rounded"></div>
                         <div class="md:col-span-2"><label for="r-name" class="text-sm">Owner Name</label><input type="text" id="r-name" placeholder="Mr. Sharma" required class="mt-1 w-full p-2 border-slate-300 rounded"></div>
                         <div class="md:col-span-1"><label for="r-amount" class="text-sm">Maint. Amount</label><input type="number" id="r-amount" placeholder="2500" required class="mt-1 w-full p-2 border-slate-300 rounded"></div>
                         <div class="md:col-span-1"><label for="r-status" class="text-sm">Status</label><select id="r-status" class="mt-1 w-full p-2 border-slate-300 rounded"><option value="Sold">Sold</option><option value="Unsold">Unsold</option><option value="Exempt">Exempt</option></select></div>
                         <div class="flex gap-2 md:col-span-1">
                             <button type="submit" id="resident-submit-btn" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md">Add</button>
                             <button type="button" id="resident-cancel-btn" class="w-full bg-slate-200 py-2 px-4 rounded-md hidden">Cancel</button>
                         </div>
                     </form>
                     <div class="overflow-x-auto"><table class="w-full">
                         <thead class="bg-slate-50"><tr>
                            <th class="p-3 text-left text-xs uppercase">Flat No.</th> <th class="p-3 text-left text-xs uppercase">Owner Name</th> <th class="p-3 text-left text-xs uppercase">Amount</th> <th class="p-3 text-left text-xs uppercase">Status</th> <th class="p-3 text-center text-xs uppercase">Actions</th>
                         </tr></thead>
                         <tbody id="residents-table-body" class="divide-y"></tbody>
                     </table></div>
                 </div>
            </div>

            <div id="detail-view" class="hidden">
                 <div class="mb-6 flex justify-between items-center">
                    <button id="back-to-dashboard-from-detail" class="text-blue-600 font-semibold flex items-center">&larr; Back to Dashboard</button>
                    <button id="export-excel-btn" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-md shadow-md hover:bg-green-700">Export to Excel</button>
                </div>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-purple-100 p-6 rounded-lg"><h3 class="font-medium text-purple-600">Opening Balance</h3><p id="opening-balance" class="text-3xl font-bold mt-2">₹0.00</p></div>
                    <div class="bg-blue-100 p-6 rounded-lg"><h3 class="font-medium text-blue-600">Collected (This Month)</h3><p id="total-collected" class="text-3xl font-bold mt-2">₹0.00</p></div>
                    <div class="bg-red-100 p-6 rounded-lg"><h3 class="font-medium text-red-600">Expenses (This Month)</h3><p id="total-expenses" class="text-3xl font-bold mt-2">₹0.00</p></div>
                    <div id="balance-card" class="p-6 rounded-lg"><h3 id="balance-label" class="font-medium">Closing Balance</h3><p id="closing-balance" class="text-3xl font-bold mt-2">₹0.00</p></div>
                </div>

                <div class="border-b border-gray-200 mb-6">
                    <nav class="-mb-px flex space-x-6" id="detail-tabs">
                        <button data-tab="status" class="py-4 px-1 border-b-2 font-medium text-sm tab-active">Payment Status</button>
                        <button data-tab="collection" class="py-4 px-1 border-b-2 font-medium text-sm text-gray-500">Maintenance Collection</button>
                        <button data-tab="expenses" class="py-4 px-1 border-b-2 font-medium text-sm text-gray-500">Expenses</button>
                    </nav>
                </div>

                <div id="tab-content">
                    <div id="status-tab">
                         <div class="bg-white p-6 rounded-lg shadow-md">
                             <div class="flex justify-between items-center mb-4">
                                <h2 class="text-2xl font-semibold">Payment Status</h2>
                                <div class="flex gap-2" id="status-filters">
                                    <button data-filter="all" class="bg-blue-500 text-white px-3 py-1 text-sm rounded">All</button>
                                    <button data-filter="pending" class="bg-gray-200 px-3 py-1 text-sm rounded">Pending</button>
                                    <button data-filter="paid" class="bg-gray-200 px-3 py-1 text-sm rounded">Paid</button>
                                </div>
                             </div>
                             <div class="overflow-x-auto"><table class="w-full">
                                 <thead class="bg-slate-50"><tr>
                                     <th class="p-3 text-left text-xs uppercase">Flat No.</th><th class="p-3 text-left text-xs uppercase">Owner Name</th><th class="p-3 text-left text-xs uppercase">Status</th>
                                 </tr></thead>
                                 <tbody id="payment-status-table" class="divide-y"></tbody>
                             </table></div>
                         </div>
                    </div>
                    <div id="collection-tab" class="hidden">
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h2 class="text-2xl font-semibold mb-4">Log Maintenance Collection</h2>
                            <form id="maintenance-form" class="grid grid-cols-1 sm:grid-cols-2 gap-4 items-end mb-6">
                                <div><label class="text-sm">Date</label><input type="date" id="m-date" required class="mt-1 w-full p-2 border-slate-300 rounded"></div>
                                <div><label class="text-sm">Flat No.</label><select id="m-flat" required class="mt-1 w-full p-2 border-slate-300 rounded"></select></div>
                                <div><label class="text-sm">Owner Name</label><input type="text" id="m-name" readonly class="mt-1 w-full p-2 bg-slate-100 border-slate-300 rounded"></div>
                                <div><label class="text-sm">Amount</label><input type="number" id="m-amount" readonly class="mt-1 w-full p-2 bg-slate-100 border-slate-300 rounded"></div>
                                <div class="sm:col-span-2"><label class="text-sm">Payment Mode</label><select id="m-mode" class="mt-1 w-full p-2 border-slate-300 rounded"><option>UPI</option><option>Bank Transfer</option><option>Cash</option><option>Cheque</option></select></div>
                                <button type="submit" class="bg-blue-600 text-white py-2 px-4 rounded-md sm:col-span-2">Add Collection</button>
                            </form>
                             <h3 class="text-xl font-semibold mt-8 mb-4">Collection Log</h3>
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead class="bg-slate-50"><tr><th class="p-3 text-left text-xs uppercase">Date</th><th class="p-3 text-left text-xs uppercase">Flat / Resident</th><th class="p-3 text-left text-xs uppercase">Amount</th><th class="p-3 text-left text-xs uppercase">Mode</th></tr></thead>
                                    <tbody id="collection-log-table" class="divide-y"></tbody>
                                </table>
                                <p id="no-collections-message" class="text-center text-slate-500 py-8 hidden">No collections logged yet.</p>
                            </div>
                        </div>
                    </div>
                    <div id="expenses-tab" class="hidden">
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h2 class="text-2xl font-semibold mb-4">Log Expense</h2>
                            <form id="expense-form" class="grid grid-cols-1 sm:grid-cols-2 gap-4 items-end mb-6">
                                <div><label class="text-sm">Date</label><input type="date" id="e-date" required class="mt-1 w-full p-2 border-slate-300 rounded"></div>
                                <div><label class="text-sm">Amount</label><input type="number" id="e-amount" required class="mt-1 w-full p-2 border-slate-300 rounded"></div>
                                <div class="sm:col-span-2"><label class="text-sm">Description</label><input type="text" id="e-desc" required class="mt-1 w-full p-2 border-slate-300 rounded"></div>
                                <button type="submit" class="bg-blue-600 text-white py-2 px-4 rounded-md sm:col-span-2">Add Expense</button>
                            </form>
                             <h3 class="text-xl font-semibold mt-8 mb-4">Expense Log</h3>
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead class="bg-slate-50"><tr><th class="p-3 text-left text-xs uppercase">Date</th><th class="p-3 text-left text-xs uppercase">Description</th><th class="p-3 text-left text-xs uppercase">Amount</th><th class="p-3 text-center text-xs uppercase">Actions</th></tr></thead>
                                    <tbody id="expense-log-table" class="divide-y"></tbody>
                                </table>
                                <p id="no-expenses-message" class="text-center text-slate-500 py-8 hidden">No expenses logged yet.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="toast" class="fixed bottom-5 left-1/2 -translate-x-1/2 bg-slate-800 text-white py-3 px-6 rounded-lg shadow-lg z-50"><span id="toast-message"></span></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, addDoc, deleteDoc, doc, updateDoc, query, where, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCqzL_cPFd2bDsuV4jhrEv2wxifZsXLVIw",
        authDomain: "society-expense-tracker.firebaseapp.com",
        projectId: "society-expense-tracker",
        storageBucket: "society-expense-tracker.appspot.com",
        messagingSenderId: "909500443985",
        appId: "1:909500443985:web:488dead071c81fb73bb770"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let state = { residents: [], sheets: [], monthlySummaries: [], collections: [], expenses: [], currentSheetId: null, currentSheetName: null, currentSheetDate: null, activeStatusFilter: 'all', editingResidentId: null, editingSummaryId: null, sheetToDelete: null, summaryToDeleteId: null, toastTimeout: null };
    const UI = {
        app: document.getElementById('app'), loading: document.getElementById('loading'), auth: document.getElementById('auth-container'), content: document.getElementById('content-container'),
        welcome: document.getElementById('welcomeMessage'), headerTitle: document.getElementById('header-title'), dashboard: document.getElementById('dashboard-view'),
        detail: document.getElementById('detail-view'), residentsView: document.getElementById('residents-view'), sheetsGrid: document.getElementById('sheets-grid'),
        noSheets: document.getElementById('no-sheets-message'), 
        totalSocietyBalance: document.getElementById('total-society-balance'),
        monthlySummaryGrid: document.getElementById('monthly-summary-grid'), noSummaryMessage: document.getElementById('no-summary-message'),
        openingBalance: document.getElementById('opening-balance'), totalCollected: document.getElementById('total-collected'), totalExpenses: document.getElementById('total-expenses'),
        balanceCard: document.getElementById('balance-card'), balanceLabel: document.getElementById('balance-label'), closingBalance: document.getElementById('closing-balance'),
        residentForm: document.getElementById('resident-form'), residentsTable: document.getElementById('residents-table-body'), detailTabs: document.getElementById('detail-tabs'),
        tabContent: document.getElementById('tab-content'), residentSubmitBtn: document.getElementById('resident-submit-btn'), residentCancelBtn: document.getElementById('resident-cancel-btn'),
        toast: document.getElementById('toast'), toastMessage: document.getElementById('toast-message'), paymentStatusTable: document.getElementById('payment-status-table'),
        statusFilters: document.getElementById('status-filters'), maintenanceForm: document.getElementById('maintenance-form'), collectionLogTable: document.getElementById('collection-log-table'),
        noCollectionsMessage: document.getElementById('no-collections-message'), expenseForm: document.getElementById('expense-form'), expenseLogTable: document.getElementById('expense-log-table'),
        noExpensesMessage: document.getElementById('no-expenses-message'),
    };
    
    const formatCurrency = (amount) => `₹${Number(amount || 0).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
    const showToast = (message, isError = false) => { UI.toastMessage.textContent = message; UI.toast.classList.toggle('bg-red-600', isError); UI.toast.classList.toggle('bg-slate-800', !isError); UI.toast.classList.add('show'); clearTimeout(state.toastTimeout); state.toastTimeout = setTimeout(() => UI.toast.classList.remove('show'), 3000); };
    const createModal = (id, title, content) => { let modal = document.getElementById(id); if (modal) modal.remove(); modal = document.createElement('div'); modal.id = id; modal.className = 'hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50'; modal.innerHTML = `<div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">${title ? `<h3 class="text-xl font-semibold mb-4">${title}</h3>` : ''}${content}</div>`; UI.app.appendChild(modal); return modal; };
    const openModal = (modal) => modal.classList.remove('hidden');
    const closeModal = (modal) => modal.classList.add('hidden');
    
    onAuthStateChanged(auth, user => { UI.loading.style.display = 'none'; UI.auth.classList.toggle('hidden', !!user); UI.content.classList.toggle('hidden', !user); if (user) { UI.welcome.textContent = `Welcome, ${user.email}`; listenForGlobalData(); navigateToDashboard(); }});
    document.getElementById('loginForm').addEventListener('submit', async e => { e.preventDefault(); try { await signInWithEmailAndPassword(auth, loginEmail.value, loginPassword.value); } catch (err) { authError.textContent = err.message; } });
    document.getElementById('logoutButton').addEventListener('click', () => signOut(auth));

    const navigateToDashboard = () => { UI.dashboard.classList.remove('hidden'); UI.detail.classList.add('hidden'); UI.residentsView.classList.add('hidden'); UI.headerTitle.textContent = "Finance Dashboard"; };
    const navigateToDetail = (sheetId, sheetName, sheetDate) => { state.currentSheetId = sheetId; state.currentSheetName = sheetName; state.currentSheetDate = sheetDate; UI.dashboard.classList.add('hidden'); UI.detail.classList.remove('hidden'); UI.residentsView.classList.add('hidden'); UI.headerTitle.textContent = `Sheet: ${sheetName}`; listenForSheetData(); switchTab('status'); };
    const navigateToResidents = () => { UI.dashboard.classList.add('hidden'); UI.detail.classList.add('hidden'); UI.residentsView.classList.remove('hidden'); UI.headerTitle.textContent = "Manage Residents"; cancelResidentEdit(); };
    document.getElementById('back-to-dashboard-from-detail').addEventListener('click', navigateToDashboard);
    document.getElementById('back-to-dashboard-from-residents').addEventListener('click', navigateToDashboard);
    document.getElementById('manage-residents-btn').addEventListener('click', navigateToResidents);

    let unsubExpenses, unsubCollections, unsubResidents, unsubSheets, unsubSummary;
    const listenForGlobalData = () => {
        if(unsubSheets) unsubSheets(); if(unsubResidents) unsubResidents(); if(unsubSummary) unsubSummary();
        unsubSheets = onSnapshot(query(collection(db, 'expense_sheets')), s => { state.sheets = s.docs.map(d => ({ id: d.id, ...d.data() })); renderDashboard(); });
        unsubResidents = onSnapshot(collection(db, 'residents'), s => { state.residents = s.docs.map(d => ({ id: d.id, ...d.data() })); renderResidentsTable(); populateFlatDropdown(); });
        unsubSummary = onSnapshot(collection(db, 'monthly_summary'), s => { state.monthlySummaries = s.docs.map(d => ({ id: d.id, ...d.data() })); renderMonthlySummary(); });
    };
    const listenForSheetData = async () => {
        if (unsubExpenses) unsubExpenses(); if (unsubCollections) unsubCollections();
        const openingBalance = await calculateOpeningBalance();
        const expenseQuery = query(collection(db, 'expenses'), where('sheetId', '==', state.currentSheetId));
        unsubExpenses = onSnapshot(expenseQuery, s => { state.expenses = s.docs.map(d => ({ id: d.id, ...d.data() })); renderAllSheetData(openingBalance); });
        const collectionQuery = query(collection(db, 'maintenance'), where('sheetId', '==', state.currentSheetId));
        unsubCollections = onSnapshot(collectionQuery, s => { state.collections = s.docs.map(d => ({ id: d.id, ...d.data() })); renderAllSheetData(openingBalance); });
    };

    const renderAllSheetData = (openingBalance) => { renderSummary(openingBalance); renderPaymentStatus(); renderCollectionLog(); renderExpenseLog(); };
    const renderDashboard = () => { const activeSheets = state.sheets.filter(s => s.status === 'active').sort((a,b) => b.createdAt.toMillis() - a.createdAt.toMillis()); UI.sheetsGrid.innerHTML = ''; UI.noSheets.classList.toggle('hidden', activeSheets.length > 0); activeSheets.forEach(sheet => { const card = document.createElement('div'); card.className = "bg-white p-6 rounded-lg shadow hover:shadow-lg flex flex-col justify-between"; card.innerHTML = `<div class="cursor-pointer flex-grow" data-sheet-id="${sheet.id}" data-sheet-name="${sheet.name}" data-sheet-date="${sheet.createdAt.toMillis()}"><h3 class="text-xl font-semibold">${sheet.name}</h3><p class="text-sm text-slate-400">${sheet.createdAt.toDate().toLocaleDateString()}</p></div><div class="text-right mt-4"><button data-id="${sheet.id}" data-name="${sheet.name}" class="text-sm text-red-500 hover:text-red-700 font-semibold delete-sheet-btn">Delete</button></div>`; UI.sheetsGrid.appendChild(card); }); };
    const renderResidentsTable = () => { UI.residentsTable.innerHTML = ''; state.residents.sort((a,b) => a.flatNo.localeCompare(b.flatNo)).forEach(res => { const row = UI.residentsTable.insertRow(); const status = res.status || 'Sold'; const statusClass = status === 'Sold' ? 'text-green-600' : 'text-slate-500'; row.innerHTML = `<td class="p-3">${res.flatNo}</td><td class="p-3">${res.ownerName}</td><td class="p-3">${formatCurrency(res.maintAmount)}</td><td class="p-3 font-medium ${statusClass}">${status}</td><td class="p-3 text-center space-x-4"><button data-id="${res.id}" class="text-blue-500 text-sm edit-resident-btn">Edit</button><button data-id="${res.id}" class="text-red-500 text-sm delete-resident-btn">Delete</button></td>`; }); };
    const renderSummary = (openingBalance) => { const totalCollected = state.collections.reduce((s,i) => s + i.amount, 0); const totalExpenses = state.expenses.reduce((s,i) => s + i.amount, 0); const closingBalance = openingBalance + totalCollected - totalExpenses; UI.openingBalance.textContent = formatCurrency(openingBalance); UI.totalCollected.textContent = formatCurrency(totalCollected); UI.totalExpenses.textContent = formatCurrency(totalExpenses); UI.closingBalance.textContent = formatCurrency(closingBalance); const isNeg = closingBalance < 0; UI.balanceCard.className = `p-6 rounded-lg ${isNeg ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}`; UI.balanceLabel.className = `font-medium ${isNeg ? 'text-red-600' : 'text-green-600'}`; UI.balanceLabel.textContent = isNeg ? 'Deficit' : 'Closing Balance'; };
    const renderPaymentStatus = () => { UI.paymentStatusTable.innerHTML = ''; const paidFlats = new Set(state.collections.map(c => c.flatNo)); let residentsToDisplay = state.residents; if (state.activeStatusFilter === 'pending') { residentsToDisplay = state.residents.filter(r => (r.status || 'Sold') === 'Sold' && !paidFlats.has(r.flatNo)); } else if (state.activeStatusFilter === 'paid') { residentsToDisplay = state.residents.filter(r => (r.status || 'Sold') === 'Sold' && paidFlats.has(r.flatNo)); } residentsToDisplay.sort((a,b) => a.flatNo.localeCompare(b.flatNo)).forEach(res => { const status = res.status || 'Sold'; const row = UI.paymentStatusTable.insertRow(); let statusHTML; if (status === 'Sold') { const isPaid = paidFlats.has(res.flatNo); const statusClass = isPaid ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'; statusHTML = `<span class="px-2 py-1 text-xs font-semibold rounded-full ${statusClass}">${isPaid ? 'Paid' : 'Pending'}</span>`; } else { statusHTML = `<span class="px-2 py-1 text-xs font-semibold rounded-full bg-slate-100 text-slate-600">N/A</span>`; } row.innerHTML = `<td class="p-3">${res.flatNo}</td><td class="p-3">${res.ownerName}</td><td class="p-3">${statusHTML}</td>`; }); };
    const renderCollectionLog = () => { UI.collectionLogTable.innerHTML = ''; const collections = state.collections.sort((a,b) => new Date(b.date) - new Date(a.date)); UI.noCollectionsMessage.classList.toggle('hidden', collections.length > 0); collections.forEach(item => { const row = UI.collectionLogTable.insertRow(); row.className = 'hover:bg-slate-50'; row.innerHTML = `<td class="p-3 text-sm">${new Date(item.date + 'T00:00:00').toLocaleDateString('en-GB')}</td><td class="p-3 text-sm">${item.flatNo} - ${item.ownerName}</td><td class="p-3 text-sm font-medium">${formatCurrency(item.amount)}</td><td class="p-3 text-sm">${item.mode}</td>`; }); };
    
    // STEP 2 CHANGE: Updated the renderExpenseLog function
    const renderExpenseLog = () => {
        UI.expenseLogTable.innerHTML = '';
        const expenses = state.expenses.sort((a,b) => new Date(b.date) - new Date(a.date));
        UI.noExpensesMessage.classList.toggle('hidden', expenses.length > 0);
        expenses.forEach(item => {
            const row = UI.expenseLogTable.insertRow();
            row.className = 'hover:bg-slate-50';
            row.innerHTML = `
                <td class="p-3 text-sm">${new Date(item.date + 'T00:00:00').toLocaleDateString('en-GB')}</td>
                <td class="p-3 text-sm">${item.description}</td>
                <td class="p-3 text-sm font-medium">${formatCurrency(item.amount)}</td>
                <td class="p-3 text-center">
                    <button data-id="${item.id}" class="text-red-500 text-sm font-semibold delete-expense-btn">Delete</button>
                </td>`;
        });
    };

    const renderMonthlySummary = () => { UI.monthlySummaryGrid.innerHTML = ''; const sortedSummaries = state.monthlySummaries.sort((a,b) => b.createdAt.toMillis() - a.createdAt.toMillis()); UI.noSummaryMessage.classList.toggle('hidden', sortedSummaries.length > 0); let totalBalance = 0; sortedSummaries.forEach(summary => { const balance = summary.totalCollection - summary.totalExpense; totalBalance += balance; const card = document.createElement('div'); card.className = 'bg-white p-4 rounded-lg shadow'; card.innerHTML = `<h4 class="font-bold text-lg text-slate-800">${summary.monthName}</h4><div class="mt-2 text-sm space-y-1"><p class="flex justify-between"><span>Collection:</span> <span class="font-semibold text-green-600">${formatCurrency(summary.totalCollection)}</span></p><p class="flex justify-between"><span>Expenses:</span> <span class="font-semibold text-red-600">${formatCurrency(summary.totalExpense)}</span></p></div><div class="text-xs text-right mt-3 space-x-3"><button data-id="${summary.id}" class="text-blue-500 hover:underline edit-summary-btn">Edit</button><button data-id="${summary.id}" data-name="${summary.monthName}" class="text-red-500 hover:underline delete-summary-btn">Delete</button></div>`; UI.monthlySummaryGrid.appendChild(card); }); UI.totalSocietyBalance.textContent = formatCurrency(totalBalance); UI.totalSocietyBalance.parentElement.classList.toggle('bg-red-600', totalBalance < 0); UI.totalSocietyBalance.parentElement.classList.toggle('bg-teal-600', totalBalance >= 0); };
    
    // --- CORE LOGIC ---
    const calculateOpeningBalance = async () => {
        const previousSheets = state.sheets.filter(s => s.status === 'active' && s.createdAt.toMillis() < state.currentSheetDate);
        if (previousSheets.length === 0) return 0;
        let totalPrevCollections = 0, totalPrevExpenses = 0;
        const sheetIds = previousSheets.map(s => s.id);
        if (sheetIds.length === 0) return 0;
        const collQuery = query(collection(db, 'maintenance'), where('sheetId', 'in', sheetIds));
        const expQuery = query(collection(db, 'expenses'), where('sheetId', 'in', sheetIds));
        const [collSnapshot, expSnapshot] = await Promise.all([getDocs(collQuery), getDocs(expQuery)]);
        collSnapshot.forEach(doc => totalPrevCollections += doc.data().amount);
        expSnapshot.forEach(doc => totalPrevExpenses += doc.data().amount);
        return totalPrevCollections - totalPrevExpenses;
    };

    // --- RESIDENT MANAGEMENT ---
    UI.residentForm.addEventListener('submit', async e => { e.preventDefault(); const btn = UI.residentSubmitBtn; btn.disabled = true; const data = { flatNo: document.getElementById('r-flat').value, ownerName: document.getElementById('r-name').value, maintAmount: parseFloat(document.getElementById('r-amount').value), status: document.getElementById('r-status').value }; if (state.editingResidentId) { btn.textContent = 'Updating...'; await updateDoc(doc(db, 'residents', state.editingResidentId), data); showToast('Resident updated.'); } else { btn.textContent = 'Adding...'; await addDoc(collection(db, 'residents'), data); showToast('Resident added.'); } cancelResidentEdit(); });
    const editResident = (id) => { state.editingResidentId = id; const res = state.residents.find(r => r.id === id); document.getElementById('r-flat').value = res.flatNo; document.getElementById('r-name').value = res.ownerName; document.getElementById('r-amount').value = res.maintAmount; document.getElementById('r-status').value = res.status || 'Sold'; UI.residentSubmitBtn.textContent = 'Update'; UI.residentSubmitBtn.classList.replace('bg-blue-600', 'bg-green-600'); UI.residentCancelBtn.classList.remove('hidden'); };
    const cancelResidentEdit = () => { state.editingResidentId = null; UI.residentForm.reset(); UI.residentSubmitBtn.textContent = 'Add'; UI.residentSubmitBtn.disabled = false; UI.residentSubmitBtn.classList.replace('bg-green-600', 'bg-blue-600'); UI.residentCancelBtn.classList.add('hidden'); };
    UI.residentCancelBtn.addEventListener('click', cancelResidentEdit);
    UI.residentsTable.addEventListener('click', async e => { const id = e.target.dataset.id; if (e.target.matches('.edit-resident-btn')) editResident(id); if (e.target.matches('.delete-resident-btn')) { if (confirm('Are you sure?')) { await deleteDoc(doc(db, 'residents', id)); showToast('Resident deleted.', true); } } });

    // --- SHEET DETAIL LOGIC ---
    const populateFlatDropdown = () => { const select = document.getElementById('m-flat'); if(!select) return; select.innerHTML = '<option value="">Select a Flat</option>'; state.residents.filter(r => (r.status || 'Sold') === 'Sold').sort((a,b) => a.flatNo.localeCompare(b.flatNo)).forEach(res => { const option = document.createElement('option'); option.value = res.flatNo; option.textContent = `${res.flatNo} - ${res.ownerName}`; select.appendChild(option); }); };
    document.querySelector('#detail-view')?.addEventListener('change', e => { if(e.target.id === 'm-flat') { const res = state.residents.find(r => r.flatNo === e.target.value); const nameInput = document.getElementById('m-name'); const amountInput = document.getElementById('m-amount'); if (res) { nameInput.value = res.ownerName; amountInput.value = res.maintAmount; } else { nameInput.value = ''; amountInput.value = ''; } } });
    document.querySelector('#maintenance-form')?.addEventListener('submit', async e => { e.preventDefault(); const flatNo = document.getElementById('m-flat').value; if (state.collections.some(c => c.flatNo === flatNo)) { showToast(`Payment for ${flatNo} already logged.`, true); return; } const data = { date: document.getElementById('m-date').value, flatNo, ownerName: document.getElementById('m-name').value, amount: parseFloat(document.getElementById('m-amount').value), mode: document.getElementById('m-mode').value, sheetId: state.currentSheetId }; if (data.flatNo && data.amount) { await addDoc(collection(db, 'maintenance'), data); e.target.reset(); document.getElementById('m-name').value = ''; document.getElementById('m-amount').value = ''; showToast('Collection added.'); } });
    document.querySelector('#expense-form')?.addEventListener('submit', async e => { e.preventDefault(); const data = { date: document.getElementById('e-date').value, amount: parseFloat(document.getElementById('e-amount').value), description: document.getElementById('e-desc').value, sheetId: state.currentSheetId, }; if (data.description && data.amount) { await addDoc(collection(db, 'expenses'), data); e.target.reset(); showToast('Expense added.'); } });
    
    // STEP 3 CHANGE: Added the event listener for the delete button
    UI.expenseLogTable.addEventListener('click', async e => {
        if (e.target.matches('.delete-expense-btn')) {
            const id = e.target.dataset.id;
            if (confirm('Are you sure you want to delete this expense? This action cannot be undone.')) {
                await deleteDoc(doc(db, 'expenses', id));
                showToast('Expense deleted.');
            }
        }
    });

    document.querySelector('#detail-tabs')?.addEventListener('click', e => { if (e.target.tagName === 'BUTTON') switchTab(e.target.dataset.tab); });
    const switchTab = (activeTab) => { const tabs = document.querySelector('#detail-tabs'); const content = document.querySelector('#tab-content'); if(!tabs || !content) return; tabs.querySelectorAll('button').forEach(btn => { btn.classList.toggle('tab-active', btn.dataset.tab === activeTab); btn.classList.toggle('text-gray-500', btn.dataset.tab !== activeTab); }); content.querySelectorAll('[id$="-tab"]').forEach(c => c.classList.toggle('hidden', !c.id.startsWith(activeTab))); };
    document.querySelector('#status-filters')?.addEventListener('click', e => { if (e.target.tagName === 'BUTTON') { state.activeStatusFilter = e.target.dataset.filter; document.querySelector('#status-filters').querySelectorAll('button').forEach(btn => { btn.classList.toggle('bg-blue-500', btn.dataset.filter === state.activeStatusFilter); btn.classList.toggle('text-white', btn.dataset.filter === state.activeStatusFilter); btn.classList.toggle('bg-gray-200', btn.dataset.filter !== state.activeStatusFilter); }); renderPaymentStatus(); } });
    
    // --- SHEET & MODAL MANAGEMENT ---
    const createSheetModal = createModal('create-sheet-modal', 'Create New Finance Sheet', `<form id="create-sheet-form"><input type="text" id="sheetName" placeholder="e.g., October 2025 Finances" required class="w-full border-slate-300 rounded-md p-2 mb-4"><div class="flex justify-end gap-3"><button type="button" class="bg-slate-200 py-2 px-4 rounded-md" data-close>Cancel</button><button type="submit" class="bg-blue-600 text-white py-2 px-4 rounded-md w-28">Create</button></div></form>`);
    const deleteSheetModal = createModal('delete-sheet-modal', 'Move Sheet to Recycle Bin', `<p id="delete-sheet-message" class="text-slate-600 mb-4"></p><div class="flex justify-end gap-3"><button type="button" class="bg-slate-200 py-2 px-4 rounded-md" data-close>Cancel</button><button type="button" id="confirm-delete-sheet" class="bg-red-600 text-white py-2 px-4 rounded-md">Yes, Move to Bin</button></div>`);
    const sheetRecycleBinModal = createModal('sheet-recycle-bin-modal', 'Sheet Recycle Bin', `<div id="sheet-recycle-bin-content" class="max-h-[60vh] overflow-y-auto"></div><div class="flex justify-end mt-4"><button type="button" class="bg-slate-200 py-2 px-4 rounded-md" data-close>Close</button></div>`);
    const addMonthModal = createModal('add-month-modal', 'Add New Month Summary', `<form id="add-month-form"><div class="mb-4"><label for="month-name" class="block text-sm">Month Name</label><input type="text" id="month-name" placeholder="e.g., October 2025" required class="mt-1 w-full p-2 border-slate-300 rounded"></div><div class="mb-4"><label for="month-collection" class="block text-sm">Total Collection</label><input type="number" id="month-collection" required class="mt-1 w-full p-2 border-slate-300 rounded"></div><div class="mb-4"><label for="month-expense" class="block text-sm">Total Expense</label><input type="number" id="month-expense" required class="mt-1 w-full p-2 border-slate-300 rounded"></div><div class="flex justify-end gap-3"><button type="button" class="bg-slate-200 py-2 px-4 rounded-md" data-close>Cancel</button><button type="submit" class="bg-green-600 text-white py-2 px-4 rounded-md w-28">Save</button></div></form>`);
    const editMonthModal = createModal('edit-month-modal', 'Edit Month Summary', `<form id="edit-month-form"><div class="mb-4"><label for="edit-month-name" class="block text-sm">Month Name</label><input type="text" id="edit-month-name" required class="mt-1 w-full p-2 border-slate-300 rounded"></div><div class="mb-4"><label for="edit-month-collection" class="block text-sm">Total Collection</label><input type="number" id="edit-month-collection" required class="mt-1 w-full p-2 border-slate-300 rounded"></div><div class="mb-4"><label for="edit-month-expense" class="block text-sm">Total Expense</label><input type="number" id="edit-month-expense" required class="mt-1 w-full p-2 border-slate-300 rounded"></div><div class="flex justify-end gap-3"><button type="button" class="bg-slate-200 py-2 px-4 rounded-md" data-close>Cancel</button><button type="submit" class="bg-green-600 text-white py-2 px-4 rounded-md w-28">Update</button></div></form>`);
    const deleteSummaryModal = createModal('delete-summary-modal', 'Delete Summary', `<p id="delete-summary-message" class="text-slate-600 mb-4"></p><div class="flex justify-end gap-3"><button type="button" class="bg-slate-200 py-2 px-4 rounded-md" data-close>Cancel</button><button type="button" id="confirm-delete-summary" class="bg-red-600 text-white py-2 px-4 rounded-md">Yes, Delete</button></div>`);

    document.getElementById('open-create-sheet-modal').addEventListener('click', () => openModal(createSheetModal));
    document.getElementById('open-sheet-recycle-bin-modal').addEventListener('click', () => { openModal(sheetRecycleBinModal); renderSheetRecycleBin(); });
    document.getElementById('open-add-month-modal').addEventListener('click', () => openModal(addMonthModal));

    addMonthModal.addEventListener('click', e => { if(e.target.matches('[data-close]')) closeModal(addMonthModal); });
    addMonthModal.querySelector('form').addEventListener('submit', async e => { e.preventDefault(); const data = { monthName: e.target.elements['month-name'].value, totalCollection: parseFloat(e.target.elements['month-collection'].value), totalExpense: parseFloat(e.target.elements['month-expense'].value), createdAt: new Date(), }; if(data.monthName && !isNaN(data.totalCollection) && !isNaN(data.totalExpense)) { await addDoc(collection(db, 'monthly_summary'), data); closeModal(addMonthModal); e.target.reset(); showToast('Monthly summary added.'); } else { showToast('Please fill all fields correctly.', true); }});
    editMonthModal.addEventListener('click', e => { if(e.target.matches('[data-close]')) closeModal(editMonthModal); });
    editMonthModal.querySelector('form').addEventListener('submit', async e => { e.preventDefault(); if (!state.editingSummaryId) return; const data = { monthName: e.target.elements['edit-month-name'].value, totalCollection: parseFloat(e.target.elements['edit-month-collection'].value), totalExpense: parseFloat(e.target.elements['edit-month-expense'].value) }; await updateDoc(doc(db, 'monthly_summary', state.editingSummaryId), data); closeModal(editMonthModal); showToast('Summary updated.'); state.editingSummaryId = null; });
    deleteSummaryModal.addEventListener('click', async e => { if(e.target.matches('[data-close]')) { closeModal(deleteSummaryModal); } if(e.target.matches('#confirm-delete-summary')) { if(state.summaryToDeleteId) { await deleteDoc(doc(db, 'monthly_summary', state.summaryToDeleteId)); showToast('Summary deleted.', true); } closeModal(deleteSummaryModal); state.summaryToDeleteId = null; } });
    UI.monthlySummaryGrid.addEventListener('click', e => {
        const id = e.target.dataset.id;
        if (e.target.matches('.edit-summary-btn')) {
            state.editingSummaryId = id;
            const summary = state.monthlySummaries.find(s => s.id === id);
            const form = editMonthModal.querySelector('form');
            form.elements['edit-month-name'].value = summary.monthName;
            form.elements['edit-month-collection'].value = summary.totalCollection;
            form.elements['edit-month-expense'].value = summary.totalExpense;
            openModal(editMonthModal);
        }
        if (e.target.matches('.delete-summary-btn')) {
            state.summaryToDeleteId = id;
            const name = e.target.dataset.name;
            deleteSummaryModal.querySelector('#delete-summary-message').textContent = `Are you sure you want to permanently delete the summary for "${name}"?`;
            openModal(deleteSummaryModal);
        }
    });
    
    createSheetModal.addEventListener('click', e => { if(e.target.matches('[data-close]')) closeModal(createSheetModal); });
    createSheetModal.querySelector('form').addEventListener('submit', async e => { e.preventDefault(); const name = e.target.elements.sheetName.value; if (name) { await addDoc(collection(db, 'expense_sheets'), { name, createdAt: new Date(), status: 'active' }); closeModal(createSheetModal); e.target.reset(); } });
    
    UI.sheetsGrid.addEventListener('click', (e) => { const btn = e.target.closest('.delete-sheet-btn'); if (btn) { state.sheetToDelete = { id: btn.dataset.id, name: btn.dataset.name }; deleteSheetModal.querySelector('#delete-sheet-message').textContent = `Move "${btn.dataset.name}" to the recycle bin?`; openModal(deleteSheetModal); } else { const card = e.target.closest('[data-sheet-id]'); if(card) navigateToDetail(card.dataset.sheetId, card.dataset.sheetName, card.dataset.sheetDate); } });
    deleteSheetModal.addEventListener('click', async e => { if (e.target.matches('[data-close]')) { closeModal(deleteSheetModal); } if (e.target.matches('#confirm-delete-sheet')) { if (!state.sheetToDelete) return; await updateDoc(doc(db, 'expense_sheets', state.sheetToDelete.id), { status: 'deleted' }); showToast(`Sheet "${state.sheetToDelete.name}" moved to bin.`); closeModal(deleteSheetModal); } });
    
    sheetRecycleBinModal.addEventListener('click', async e => { if (e.target.matches('[data-close]')) { closeModal(sheetRecycleBinModal); } const id = e.target.dataset.id; if (e.target.matches('.restore-sheet-btn')) { await updateDoc(doc(db, 'expense_sheets', id), { status: 'active' }); showToast('Sheet restored.'); } if (e.target.matches('.perm-delete-sheet-btn')) { if (!confirm('This will delete the sheet and ALL its data permanently. Are you sure?')) return; const queries = [query(collection(db, 'expenses'), where('sheetId', '==', id)), query(collection(db, 'maintenance'), where('sheetId', '==', id))]; const [expDocs, mainDocs] = await Promise.all(queries.map(q => getDocs(q))); const batch = writeBatch(db); expDocs.forEach(d => batch.delete(d.ref)); mainDocs.forEach(d => batch.delete(d.ref)); batch.delete(doc(db, 'expense_sheets', id)); await batch.commit(); showToast('Sheet permanently deleted.', true); } });
    const renderSheetRecycleBin = () => { const deletedSheets = state.sheets.filter(s => s.status === 'deleted'); const container = sheetRecycleBinModal.querySelector('#sheet-recycle-bin-content'); container.innerHTML = ''; if (deletedSheets.length === 0) { container.innerHTML = '<p class="text-center text-slate-500 py-8">Sheet recycle bin is empty.</p>'; return; } deletedSheets.forEach(sheet => { const el = document.createElement('div'); el.className="flex justify-between items-center p-3 border-b"; el.innerHTML=`<p>${sheet.name}</p><div><button data-id="${sheet.id}" class="text-blue-600 font-semibold mr-4 restore-sheet-btn">Restore</button><button data-id="${sheet.id}" class="text-red-600 font-semibold perm-delete-sheet-btn">Delete Forever</button></div>`; container.appendChild(el); }); };

    // --- EXCEL EXPORT ---
    document.getElementById('export-excel-btn').addEventListener('click', async () => {
        const openingBalance = await calculateOpeningBalance();
        const totalCollected = state.collections.reduce((s, i) => s + i.amount, 0);
        const totalExpenses = state.expenses.reduce((s, i) => s + i.amount, 0);
        const closingBalance = openingBalance + totalCollected - totalExpenses;
        const wb = XLSX.utils.book_new();

        const headerStyle = { font: { bold: true, color: { rgb: "FFFFFF" } }, fill: { fgColor: { rgb: "4F81BD" } } };
        const currencyFormat = '"₹"#,##0.00';

        const summaryData = [
            [{v: `Financial Summary: ${state.currentSheetName}`, s: { font: { bold: true, sz: 16 } }}], [],
            [{v: 'Category', s: headerStyle}, {v: 'Amount', s: headerStyle}],
            ['Opening Balance', {v: openingBalance, t: 'n', z: currencyFormat }],
            ['Total Maintenance Collected', {v: totalCollected, t: 'n', z: currencyFormat }],
            ['Total Expenses', {v: totalExpenses, t: 'n', z: currencyFormat }],
            [{v: 'Closing Balance', s: {font: {bold: true}}}, {v: closingBalance, t: 'n', z: currencyFormat, s: closingBalance < 0 ? { font: { color: {rgb: "FF0000"}}} : {}}],
        ];
        const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
        wsSummary['!cols'] = [{wch: 30}, {wch: 20}];
        XLSX.utils.book_append_sheet(wb, wsSummary, 'Summary');

        const maintHeaders = ['Date', 'Flat No.', 'Owner Name', 'Amount', 'Payment Mode'];
        const maintData = state.collections.sort((a,b)=> new Date(b.date) - new Date(a.date)).map(i => [new Date(i.date + 'T00:00:00').toLocaleDateString('en-GB'), i.flatNo, i.ownerName, i.amount, i.mode]);
        const wsMaint = XLSX.utils.aoa_to_sheet([maintHeaders, ...maintData]);
        maintHeaders.forEach((h, i) => { const cell = wsMaint[XLSX.utils.encode_cell({c: i, r: 0})]; if(cell) cell.s = headerStyle; });
        for(let i=0; i < maintData.length; i++) { const cell = wsMaint[XLSX.utils.encode_cell({c: 3, r: i+1})]; if(cell) { cell.t = 'n'; cell.z = currencyFormat; } }
        wsMaint['!cols'] = [{wch: 12}, {wch: 12}, {wch: 25}, {wch: 15}, {wch: 15}];
        XLSX.utils.book_append_sheet(wb, wsMaint, 'Maintenance Collection');

        const expHeaders = ['Date', 'Description', 'Amount'];
        const expData = state.expenses.sort((a,b)=> new Date(b.date) - new Date(a.date)).map(i => [new Date(i.date + 'T00:00:00').toLocaleDateString('en-GB'), i.description, i.amount]);
        const wsExp = XLSX.utils.aoa_to_sheet([expHeaders, ...expData]);
        expHeaders.forEach((h, i) => { const cell = wsExp[XLSX.utils.encode_cell({c: i, r: 0})]; if(cell) cell.s = headerStyle; });
        for(let i=0; i < expData.length; i++) { const cell = wsExp[XLSX.utils.encode_cell({c: 2, r: i+1})]; if(cell) { cell.t = 'n'; cell.z = currencyFormat; } }
        wsExp['!cols'] = [{wch: 12}, {wch: 40}, {wch: 15}];
        XLSX.utils.book_append_sheet(wb, wsExp, 'Expenses');

        XLSX.writeFile(wb, `${state.currentSheetName.replace(/\s+/g, '_')}_Report.xlsx`);
    });
</script>
</body>
</html>